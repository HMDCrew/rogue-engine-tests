{"version":3,"file":"rogue-editor-user-scripts.js","mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,O;;;;;;;;;;;;;;;;;;;;;;ACVA;AACA;AAEA;AACA;AACA;AACA;AAEe,kCAAkC,mDAAY,CAAC;AAAA,EAA9D,cARA;AAQA;AAGE,2BAAoC;AACpC,qBAA6C;AAE7C,iBAAQ,IAAI,+CAAkB,CAC5B,IAAI,iDAAoB,IACxB,IAAI,oDAAuB,CAAC,EAAE,OAAO,IAAI,wCAAW,CAAC;AAIvD,8BAAqB;AAEb,kCAAyB,EAAE,MAAM,MAAM;AAAA;AACvC,oCAA2B,EAAE,MAAM,MAAM;AAAA;AAEzC,wBAAe,EAAE,MAAM,MAAM;AAAA;AAE7B,wBAAe,wBAAC,cAA4B;AAClD,2BAAqB,iEAAc,IAAI,KAAK;AAAA,OADvB;AAAA;AAAA,QAIjB,cAAc;AAClB,UAAM,sEAAW;AAAJ;AAAA,EAGf,QAAQ;AACN,SAAK,qBAAqB;AAE1B,SAAK,MAAM,SAAS;AACpB,SAAK,MAAM,gBAAgB;AAE3B,QAAI;AACF,WAAK,OAAO;AAAA,YACZ;AAAA;AAAQ;AAEV,SAAK,cAAc,KAAK,MAAM;AAC5B,WAAK,QAAQ,IAAI,uEAAY,CAAC,EAAC,GAAG,GAAG,GAAG,GAAG,GAAG;AAC9C,gGAAiB,GAAG,KAAK;AACzB,WAAK,qBAAqB;AAAA;AAG5B,qEAA0B,CAAC,KAAK;AAEhC,SAAK,MAAM,SAAS,iBAAiB;AACrC,kEAAuB,CAAC,KAAK;AAE7B,SAAK,uBAAuB;AAC5B,SAAK,yBAAyB;AAC9B,SAAK,aAAa;AAElB,SAAK,yBAAyB,0DAAmB,CAAC,KAAK;AACvD,SAAK,2BAA2B,4DAAqB,CAAC,KAAK;AAE3D,SAAK,eAAe,wDAAiB,CAAC,MAAM;AAC1C,UAAI;AACF,aAAK,OAAO;AAAA,cACZ;AAAA;AAAQ;AACV,WAAK,uBAAuB;AAC5B,WAAK,yBAAyB;AAAA;AAAA;AAAA,EAIlC,kBAAkB;AAChB,SAAK,gBAAgB,QAAQ,cAAY;AACvC,UAAI,CAAC;AAAU;AACf,eAAS,SAAS,YAAU;AAC1B,cAAM,gBAAgB,oDAAa,CAAC,OAAO;AAE3C,YAAI,CAAC;AAAe;AAEpB,sBAAc,QAAQ,eAAa;AACjC,cAAI,qBAAqB,sDAAU,IAAI,qBAAqB,iEAAc,EAAE;AAC1E,sBAAU,cAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOlC,cAAc;AACZ,SAAK,MAAM,UAAU;AACrB,QAAI,CAAC,KAAK;AAAoB;AAE9B,UAAM,kBAAkB,OAAO,gBAAgB,QAAQ;AAEvD,QAAI,CAAC,KAAK,eAAe,iBAAiB,KAAK,kBAAkB;AAC/D,WAAK,kBAAkB,gBAAgB,MAAM;AAC7C,WAAK;AACL,WAAK;AAAA;AAGP,QAAI,CAAC,KAAK,SAAU,KAAK,SAAS,KAAK,MAAM,OAAO,UAAU,GAAI;AAChE;AAAA;AAGF,SAAK;AAAA;AAAA,EAGC,kBAAkB;AACxB,SAAK,MAAM,UAAU;AAErB,SAAK,MAAM;AAEX,UAAM,iBAAkD;AAExD,SAAK,UAAU,QAAQ,eAAa;AAClC,UAAI,qBAAqB,iEAAc,IAAI,UAAU,YAAY,UAAU,eAAe;AACxF,YAAI,CAAC,UAAU,WAAW,CAAC,UAAU,cAAc,SAAS;AAC1D,oBAAU,cAAc;AACxB,yBAAe,KAAK;AACpB;AAAA;AAEF,cAAM,MAAM,UAAU,cAAc,SAAS;AAC7C,cAAM,MAAM,UAAU,cAAc,SAAS;AAC7C,kBAAU,KAAK,eAAe,IAAI,yEAAc,CAAC,IAAI,GAAG,IAAI,GAAG,IAAI,IAAI;AACvE,kBAAU,KAAK,YAAY,IAAI,4EAAiB,CAAC,IAAI,GAAG,IAAI,GAAG,IAAI,GAAG,IAAI,IAAI;AAC9E,kBAAU;AACV,kBAAU;AAAA;AAAA;AAId,QAAI,eAAe,SAAS,GAAG;AAC7B,WAAK;AACL,WAAK;AAAA;AAGP,mBAAe,QAAQ,eAAa,KAAK,UAAU,OAAO,KAAK,UAAU,QAAQ,YAAY;AAE7F,QAAI,UAAU,KAAK,MAAM;AAEzB,SAAK,MAAM,SAAS,aAClB,YACA,IAAI,kDAAqB,CAAC,QAAQ,UAAU;AAG9C,SAAK,MAAM,SAAS,aAClB,SACA,IAAI,kDAAqB,CAAC,QAAQ,QAAQ;AAAA;AAAA,QAIhC,mBAAmB;AAC/B,8FAAiB,IAAI,yGAAgC,CAAC,UAAQ,0GAAiC,CAAC;AAChG,SAAK,MAAM,UAAU;AACrB,qEAA0B,CAAC,KAAK;AAEhC,SAAK,YAAY;AAAA;AAAA,QAGL,iBAAiB;AAC7B,UAAM,KAAK;AAEX,QAAI,KAAK,gBAAgB,cAAc,wCAAW;AAAE;AAEpD,SAAK,gBAAgB,QAAQ,cAAY;AACvC,eAAS,SAAS,YAAU;AAC1B,cAAM,gBAAgB,oDAAa,CAAC,OAAO;AAE3C,YAAI,CAAC;AAAe;AAEpB,sBAAc,QAAQ,eAAa;AACjC,cAAI,qBAAqB,sDAAU,EAAE;AACnC,sBAAU;AACV,iBAAK,UAAU,KAAK;AAAA;AAGtB,cAAI,qBAAqB,iEAAc,EAAE;AACvC,kBAAM,gBAAgB,UAAU,iBAAiB,UAAU;AAE3D,gBAAI,eAAe;AACjB,4BAAc;AAAA;AAGhB,sBAAU;AAGV,iBAAK,UAAU,KAAK;AAAA;AAAA;AAAA;AAAA;AAM5B,kEAAuB,CAAC,KAAK;AAAA;AAAA,EAGvB,eAAe,QAAe,QAAe;AACnD,QAAI,OAAO,WAAW,OAAO;AAAQ,aAAO;AAE5C,WAAO,OAAO,MAAM,CAAC,SAAS,MAAM;AAClC,aAAO,OAAO,OAAO;AAAA;AAAA;AAAA,EAIzB,kBAAkB;AAChB,qEAA0B,CAAC,KAAK;AAChC,SAAK,uBAAuB;AAC5B,SAAK,yBAAyB;AAC9B,SAAK,aAAa;AAClB,SAAK;AAAA;AAAA;AAxMT;AACS,wCAAoB;AA2M7B,2DAAoB,CAAC","sources":["webpack://[name]/webpack/universalModuleDefinition","webpack://[name]/./Assets/rogue_packages/RogueEngine/rogue-rapier/Components/_Editor/RapierBodyWireframe.re.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"rogue-editor-user-scripts\"] = factory();\n\telse\n\t\troot[\"rogue-editor-user-scripts\"] = factory();\n})(self, function() {\nreturn ","import * as RE from 'rogue-engine';\r\nimport * as THREE from 'three';\r\n\r\nimport RapierCollider from '../Colliders/RapierCollider';\r\nimport RAPIER from '@dimforge/rapier3d-compat';\r\nimport RapierBody from '../RapierBody.re';\r\nimport RogueRapier from '@RE/RogueEngine/rogue-rapier/Lib/RogueRapier';\r\n\r\nexport default class RapierBodyWireframe extends RE.Component {\r\n  static isEditorComponent = true;\r\n\r\n  selectedObjects: THREE.Object3D[] = [];\r\n  colliders: (RapierCollider | RapierBody)[] = [];\r\n\r\n  lines = new THREE.LineSegments(\r\n    new THREE.BufferGeometry(),\r\n    new THREE.LineBasicMaterial({ color: new THREE.Color(\"#00FF00\") })\r\n  );\r\n\r\n  world: RAPIER.World;\r\n  initializedPhysics = false;\r\n\r\n  private handleOnComponentAdded = { stop: () => { } };\r\n  private handleOnComponentRemoved = { stop: () => { } };\r\n\r\n  private handleOnPlay = { stop: () => { } };\r\n\r\n  private resetHandler = (component: RE.Component) => {\r\n    component instanceof RapierCollider && this.setupImpostors();\r\n  }\r\n\r\n  async initPhysics() {\r\n    await RAPIER.init();\r\n  }\r\n\r\n  start() {\r\n    this.initializedPhysics = false;\r\n\r\n    this.lines.geometry.computeBoundingSphere();\r\n    this.lines.frustumCulled = false;\r\n\r\n    try {\r\n      this.world?.free();\r\n    } catch {};\r\n\r\n    this.initPhysics().then(() => {\r\n      this.world = new RAPIER.World({x: 0, y: 0, z: 0});\r\n      RogueRapier.world = this.world;\r\n      this.initializedPhysics = true;\r\n    });\r\n\r\n    RE.App.currentScene.remove(this.lines);\r\n\r\n    this.lines.userData.isEditorObject = true;\r\n    RE.App.currentScene.add(this.lines);\r\n\r\n    this.handleOnComponentAdded.stop();\r\n    this.handleOnComponentRemoved.stop();\r\n    this.handleOnPlay.stop();\r\n\r\n    this.handleOnComponentAdded = RE.onComponentAdded(this.resetHandler);\r\n    this.handleOnComponentRemoved = RE.onComponentRemoved(this.resetHandler);\r\n\r\n    this.handleOnPlay = RE.Runtime.onPlay(() => {\r\n      try {\r\n        this.world?.free();\r\n      } catch {};\r\n      this.handleOnComponentAdded.stop();\r\n      this.handleOnComponentRemoved.stop();\r\n    });\r\n  }\r\n\r\n  resetComponents() {\r\n    this.selectedObjects.forEach(selected => {\r\n      if (!selected) return;\r\n      selected.traverse(object => {\r\n        const objComponents = RE.components[object.uuid];\r\n\r\n        if (!objComponents) return;\r\n\r\n        objComponents.forEach(component => {\r\n          if (component instanceof RapierBody || component instanceof RapierCollider) {\r\n            component.initialized = false;\r\n          }\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  afterUpdate() {\r\n    this.lines.visible = false;\r\n    if (!this.initializedPhysics) return;\r\n\r\n    const selectedObjects = window[\"rogue-editor\"].Project.selectedObjects as THREE.Object3D[];\r\n\r\n    if (!this.arraysAreEqual(selectedObjects, this.selectedObjects)) {\r\n      this.selectedObjects = selectedObjects.slice(0);\r\n      this.resetComponents();\r\n      this.setupImpostors();\r\n    }\r\n\r\n    if (!this.world || (this.world && this.world.bodies.len() === 0)) {\r\n      return;\r\n    }\r\n\r\n    this.updateImpostors();\r\n  }\r\n\r\n  private updateImpostors() {\r\n    this.lines.visible = true;\r\n\r\n    this.world.step();\r\n\r\n    const flagForRemoval: (RapierCollider | RapierBody)[] = [];\r\n\r\n    this.colliders.forEach(component => {\r\n      if (component instanceof RapierCollider && component.object3d && component.bodyComponent) {\r\n        if (!component.enabled || !component.bodyComponent.enabled) {\r\n          component.initialized = false;\r\n          flagForRemoval.push(component);\r\n          return;\r\n        }\r\n        const pos = component.bodyComponent.object3d.position;\r\n        const rot = component.bodyComponent.object3d.quaternion;\r\n        component.body.setTranslation(new RAPIER.Vector3(pos.x, pos.y, pos.z), false);\r\n        component.body.setRotation(new RAPIER.Quaternion(rot.x, rot.y, rot.z, rot.w), false);\r\n        component.setColliderRot();\r\n        component.setColliderPos();\r\n      }\r\n    });\r\n\r\n    if (flagForRemoval.length > 0) {\r\n      this.resetComponents();\r\n      this.setupImpostors();\r\n    }\r\n\r\n    flagForRemoval.forEach(component => this.colliders.splice(this.colliders.indexOf(component), 1));\r\n\r\n    let buffers = this.world.debugRender();\r\n\r\n    this.lines.geometry.setAttribute(\r\n      \"position\",\r\n      new THREE.BufferAttribute(buffers.vertices, 3),\r\n    );\r\n\r\n    this.lines.geometry.setAttribute(\r\n      \"color\",\r\n      new THREE.BufferAttribute(buffers.colors, 4),\r\n    );\r\n  }\r\n\r\n  private async cleanupImpostors() {\r\n    RogueRapier.world && RogueRapier.world.bodies.forEach(body => RogueRapier.world.removeRigidBody(body));\r\n    this.lines.visible = false;\r\n    RE.App.currentScene.remove(this.lines);\r\n\r\n    this.colliders = [];\r\n  }\r\n\r\n  private async setupImpostors() {\r\n    await this.cleanupImpostors();\r\n\r\n    if (this.selectedObjects[0] instanceof THREE.Scene) return;\r\n\r\n    this.selectedObjects.forEach(selected => {\r\n      selected.traverse(object => {\r\n        const objComponents = RE.components[object.uuid];\r\n\r\n        if (!objComponents) return;\r\n\r\n        objComponents.forEach(component => {\r\n          if (component instanceof RapierBody) {\r\n            component.init();\r\n            this.colliders.push(component);\r\n          }\r\n\r\n          if (component instanceof RapierCollider) {\r\n            const bodyComponent = component.getBodyComponent(component.object3d);\r\n\r\n            if (bodyComponent) {\r\n              bodyComponent.init();\r\n            }\r\n\r\n            component.init();\r\n            // component.collider && \r\n            // component.collider.setSensor(true);\r\n            this.colliders.push(component);\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    RE.App.currentScene.add(this.lines);\r\n  }\r\n\r\n  private arraysAreEqual(array1: any[], array2: any[]) {\r\n    if (array1.length !== array2.length) return false;\r\n\r\n    return array1.every((element, i) => {\r\n      return array2[i] === element;\r\n    });\r\n  }\r\n\r\n  onBeforeRemoved() {\r\n    RE.App.currentScene.remove(this.lines);\r\n    this.handleOnComponentAdded.stop();\r\n    this.handleOnComponentRemoved.stop();\r\n    this.handleOnPlay.stop();\r\n    this.cleanupImpostors();\r\n  }\r\n}\r\n\r\nRE.registerComponent(RapierBodyWireframe);\r\n"],"names":[],"sourceRoot":""}